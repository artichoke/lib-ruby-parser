use lib_ruby_parser_bindings::helpers::messages::variant_predicate as bindings_variant_predicate;

fn contents() -> String {
    let messages = lib_ruby_parser_nodes::messages();

    format!(
        "// This file is auto-generated by {generator}

use super::{{DiagnosticMessage, DiagnosticMessageBlob}};

extern \"C\" {{
    {extern_predicates}
}}

impl DiagnosticMessage {{
    {foreign_predicates}
}}
",
        generator = file!(),
        extern_predicates = messages.map(&extern_predicate).join("\n    "),
        foreign_predicates = messages.map(&foreign_predicate).join("\n    "),
    )
}

pub(crate) fn codegen() {
    std::fs::write("src/error/message/external/predicates.rs", contents()).unwrap();
}

fn extern_predicate(message: &lib_ruby_parser_nodes::Message) -> String {
    format!(
        "fn {name}(blob: *const DiagnosticMessageBlob) -> bool;",
        name = bindings_variant_predicate::name(message),
    )
}

fn foreign_predicate(message: &lib_ruby_parser_nodes::Message) -> String {
    format!(
        "/// Returns true if current variant is {variant}
    pub fn is_{variant}(&self) -> bool {{
        let message_blob_ptr: *const DiagnosticMessageBlob = &self.blob;
        unsafe {{ {extern_predicate}(message_blob_ptr) }}
    }}",
        variant = message.lower_name(),
        extern_predicate = bindings_variant_predicate::name(message)
    )
}
